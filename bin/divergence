#!/usr/bin/env ruby

require "thor"
require "thor/group"

module CLI
  class Init < Thor::Group
    include ::Thor::Actions

    desc "Initializes a divergence application into the current directory"

    def self.source_root
      ::File.expand_path('../../generators/files',  __FILE__)
    end

    def create_directories
      empty_directory "config"
      empty_directory "log"
      empty_directory "public"
      empty_directory "tmp"
    end

    def copy_templates
      template "config.rb", "config/config.rb"
      template "callbacks.rb", "config/callbacks.rb"
      template "config.ru", "config.ru"
      template "Gemfile", "Gemfile"
    end
  end
end

module CLI
  class Base < Thor
    register CLI::Init, "init", "init", "Initializes a divergence application into the current directory"

    desc "start", "Start divergence in development mode"
    method_options :port => :number
    def start
      if options[:port]
        `rackup -p #{options[:port]}`
      else
        `rackup`
      end
    end
  end
end

CLI::Base.start